SET(RT_DIR ${CMAKE_CURRENT_SOURCE_DIR}/../reftek_libs)
SET(RT_INC ${RT_DIR}/include)
SET(REFTEKDIR ${RT_DIR}/reftek)
SET(REFTEKLIB ${REFTEKDIR}/libreftek.a)
SET(RTPDIR ${RT_DIR}/rtp)
SET(RTPLIB ${RTPDIR}/librtp.a)
SET(RTUTILDIR ${RT_DIR}/util)
SET(RTUTILLIB ${RTUTILDIR}/libutil.a)

SET(REFTEKPLUGIN_SOURCES
	reftek_plugin.cc
	../plugin.c
)

INCLUDE_DIRECTORIES(.)
INCLUDE_DIRECTORIES(..)
INCLUDE_DIRECTORIES(../../libs/plugin)
INCLUDE_DIRECTORIES(${RT_INC})

SET(CONFIG_FILE ${SC3_PACKAGE_INSTALL_PREFIX}/acquisition/config/plugins.ini)

SET(OPTIONS -DSYSLOG_FACILITY=LOG_LOCAL0 -DCONFIG_FILE=\\\"${CONFIG_FILE}\\\")

IF (MACOSX)
    SET(PLATFORM -DMACOSX -D_REENTRANT)
ELSEIF(LINUX)
    SET(PLATFORM -DLINUX -D_REENTRANT -Dunix)
ENDIF (MACOSX)

ADD_DEFINITIONS(${OPTIONS} ${PLATFORM})


ADD_EXECUTABLE(reftek_plugin ${REFTEKPLUGIN_SOURCES})

ADD_CUSTOM_COMMAND(
	OUTPUT ${REFTEKLIB} ${RTPLIB} ${RTUTILLIB}
	COMMAND ${CMAKE_MAKE_PROGRAM} ARGS -C ${REFTEKDIR} PLATFORM="${PLATFORM}"
	COMMAND ${CMAKE_MAKE_PROGRAM} ARGS -C ${RTPDIR} PLATFORM="${PLATFORM}"
	COMMAND ${CMAKE_MAKE_PROGRAM} ARGS -C ${RTUTILDIR} PLATFORM="${PLATFORM}"
)

SET_SOURCE_FILES_PROPERTIES(
	reftek_plugin.cc
	PROPERTIES OBJECT_DEPENDS ${REFTEKLIB} ${RTPLIB} ${RTUTILLIB}
)


TARGET_LINK_LIBRARIES(
	reftek_plugin
		${REFTEKLIB}
		${RTPLIB}
		${RTUTILLIB}
		slplugin
		slutils
)

INSTALL(TARGETS reftek_plugin RUNTIME DESTINATION ${SEEDLINK_PLUGIN_OUTPUT_DIR})

FILE(GLOB descs "${CMAKE_CURRENT_SOURCE_DIR}/descriptions/*.xml")
INSTALL(FILES ${descs} DESTINATION ${SC3_PACKAGE_APP_DESC_DIR})
